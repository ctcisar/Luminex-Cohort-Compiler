# Luminex-Cohort-Compiler
# User Guide

==Index
1. Overview and usage
  1.1 How to run
  1.2 Dependencies
    1.2.1 Installing dependencies
2. Input
3. Output
4. scriptconfig.ini definitions and flags
  4.1 [input]
  4.2 [analysis]
  4.3 [output]
  4.4 [debugging]
5. Known Issues

==1. OVERVIEW AND USAGE

This script compiles multiple output files that belong to the same cohort of samples, as generated by the Luminex Bioplex Pro Software.  Additionally, rudimentary data analysis tools are included to quantify amounts of cross-plate variation, given a set of identical control samples, and samples can be filtered based on beadcount.

=1.1 How to run

Export all plates of data from Bioplex Pro as .xls files as detailed in section 2.  Paste all these files into a directory named "Luminex Documents".  In the directory containing the "Luminex Documents" folder, paste script.py and scriptconfig.ini.  Configure scriptconfig.ini as detailed in section 4.  Run script.py.

=1.2 Dependencies

The following must be installed for the script to run:

-Python
-numpy
-scipy
-openpyxl
-configparser

1.2.1 Installing dependencies

Install the latest version of python from https://www.python.org/downloads/ 

Follow the steps at the following link to ensure that python and pip are installed and running https://packaging.python.org/tutorials/installing-packages/#requirements-for-installing-packages

In command line, run the following (all one line):
python -m pip install --user numpy scipy matplotlib ipython jupyter pandas sympy nose openpyxl configparser

==2. INPUT

The input files are .xls files exported from Bioplex Pro.  

Before exporting the results file, the "Description" column MUST be enabled. From the table view, click the "export as .xls file" button and save as "Multiple Analyte Layout".

File name MUST end with _[plate number][plate type ID]  All files with the same plate number have the same samples; all files with the same plate type ID have the same set of antigens.  The total number of plates and the names of the plate types MUST be defined in scriptconfig.ini, as detailed in section 4.  Even if only one set of antigens is used, a single plate type must be defined.

File names MUST be identical before this suffix. This static portion of the name MUST be defined in scriptconfig.ini

Files MUST be in a directory called "Luminex Documents" in the same folder as script.py. 

More specifics regarding naming conventions for replicates and controls can be found in section 4. 

==3. OUTPUT

There are two output files generated by this script, which are saved in the same directory as script.py.

[name]_master.xlsx contains one sheet named "master" with processed data and controls removed. If you trust that all plates are comparable, then this is the only file you need.

[name]_combined.xlsx contains multiple sheets. 
-"Combined" contains the unprocessed data from all the input workbooks, stitched together in one sheet. Datapoints with low beadcounts have been replaced with "NA".  Sample names have a prefix of "[Plate number]_".
-"CVs" contains coefficient of variance values for specified controls across all plates. Color coding is defined in scriptconfig.ini, specified in section 4.3. If "include_perplate_controls" is set to true, then the averaged values of each control is listed for each plate. This can be useful for identifying plates with more variance.
--if normalize_cvs is True, there will be numbered CV sheets. CV 1 are the un-normalized CVs, CVs 0 are the final (post-normalization) CVs.  If save_all_cvs is True, there will be additional sheets numbered >2 for each iteration of the minimization function.
-"master" is the same as the sheet with an identical name in "[name]_master.xlsx".


==4. SCRIPTCONFIG.INI DEFINITIONS AND FLAGS

All flags have specified default values except those in [input]; All parameters in [input] MUST be specified for the script to run. Note that to set a value to True, True is case-sensitive.

=4.1 [input]

name - file name before "_[plate number][plate type]" that is identical across all samples. Further detailed in section 2.
plate_count - number of plates with unique samples in this cohort
plate_types - names of plate types with unique antigens in this cohort

All files with the same samples are of the same plate number; All files with the same antigens are the same plate type.  That is to say, each plate number corresponds to a set of samples that is replicated across multiple antigen sets ("bead mixes").  Even if there is only one bead mix/plate type, it MUST be defined with a name and identical accross all samples.

=4.2 [analysis]

bead_cutoff (25) - samples with beadcounts lower than this will be replaced with "NA".
control_names (False) - if specified, looks for samples with identical names on each plate to use as controls.  MUST be specified in each file.  If unspecified, will look for any samples that have "control" in the name.
combine_controls (False) - Does not work if control_names has been specified. Disregards everything after a "-" when grouping controls.  Ex: When true, "Control 1-1" and "Control 1-2" will be treated as identical controls.
normalize_cvs (False) - Finds linear coefficients that, once applied to each plate, minimize the average of all cross-plate control CVs.

=4.3 [output]

The following apply to the values in CV sheets in "[name]_combined.xlsx"

cv_warning (10) - CV values higher than this but lower than cv_error will be warning_color
cv_error (25) - CV values higher than this will be error_color
zsc_warning (1.5) - if perplate_controls is True, control values with a zscore greater than this but less than zsc_error will be warning_color
zsc_error (2.0) - if perplate_controls is True, control values with a zscore greater than this will be error_color

warning_color (FFFFA500) - the color of CV/control values in the "warning" range, represented as a hexidecimal value where the first two digits are opacity.
error_color (FFFF0000) - the color of CV/control values in the "error" range, represented as a hexidecimal value where the first two digits are opacity.

=4.4 [debugging]

verbose_output (False) - Adds a lot of intermediate script output to shell window to help debug errors. Slows down script a lot.
include_perplate_controls (False) - Adds each plate's control values to "CV" sheets in "[name]_combined.xlsx".  Adds additional columns next to antigens that tally total warnings and errors (as defined per values in 4.3) per plate.
tally_perplate_na (False) - Prints the number of datapoints that were ommitted because of low bead count for each plate in the shell.
beadcount_sheet (False) - Adds a sheet to "[name]_combined.xlsx" with the beadcount of each sample.
save_all_cvs (False) - If normalize_cvs is True, will also save the intermediate CV sheets while iterating to find local minimum to "[name]_combined.xlsx". Slows down script a lot.

==5. KNOWN ISSUES

Enabling analysis/combine_controls breaks both debugging/include_perplate_controls and analysis/normalize_cvs.  